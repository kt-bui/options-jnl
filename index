<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Options Wheel Tracker Pro</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.0/crypto-js.min.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <style>
        :root {
            --color-primary: #208081;
            --color-primary-hover: #1a6567;
            --color-primary-active: #1a5456;
            --color-bg: #faf8f6;
            --color-surface: #ffffff;
            --color-text: #1a1a1a;
            --color-text-secondary: #666666;
            --color-border: #e0e0e0;
            --color-success: #22c55e;
            --color-error: #ef4444;
        }

        * { box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: var(--color-bg); color: var(--color-text); margin: 0; padding: 1rem; }
        .auth-container { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(135deg, #208081 0%, #1a6567 100%); display: flex; align-items: center; justify-content: center; z-index: 2000; padding: 20px; }
        .auth-container.hidden { display: none; }
        .auth-box { background: var(--color-surface); padding: 3rem; border-radius: 12px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); max-width: 400px; width: 100%; text-align: center; }
        .auth-box h2 { color: var(--color-primary); margin: 0 0 1rem 0; font-size: 1.8rem; }
        .auth-box p { color: var(--color-text-secondary); margin: 0 0 1.5rem 0; }
        .google-signin-wrapper { display: flex; justify-content: center; margin: 2rem 0; }
        .loading-spinner { display: inline-block; width: 30px; height: 30px; border: 4px solid rgba(0,0,0,0.1); border-top: 4px solid var(--color-primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .container { max-width: 1200px; margin: 0 auto; }
        header { background: var(--color-surface); padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        h1 { margin: 0; font-size: 2rem; color: var(--color-primary); }
        .user-header { display: flex; align-items: center; gap: 1rem; background: rgba(32, 128, 129, 0.1); padding: 0.75rem 1rem; border-radius: 8px; margin-top: 1.5rem; }
        .user-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
        .user-info { flex: 1; text-align: left; }
        .user-name { font-weight: 600; margin: 0; color: var(--color-text); }
        .user-email { font-size: 0.85rem; color: var(--color-text-secondary); margin: 0; }
        .logout-btn { padding: 0.5rem 1rem; background: var(--color-error); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; }
        .logout-btn:hover { background: #d32f2f; }
        .encryption-status { font-size: 0.8rem; color: var(--color-success); text-align: center; margin-top: 1rem; }
        .tabs { display: flex; gap: 0.5rem; margin-bottom: 2rem; flex-wrap: wrap; }
        .tab-btn { padding: 0.75rem 1.5rem; border: 2px solid var(--color-border); background: var(--color-surface); color: var(--color-text); cursor: pointer; border-radius: 6px; font-weight: 500; transition: all 0.2s; }
        .tab-btn.active { background: var(--color-primary); color: white; border-color: var(--color-primary); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .form-section { background: var(--color-surface); padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem; }
        .form-group { display: flex; flex-direction: column; }
        label { font-weight: 600; margin-bottom: 0.5rem; }
        input, select { padding: 0.75rem; border: 1px solid var(--color-border); border-radius: 6px; font-size: 1rem; }
        input:focus, select:focus { outline: none; border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(32, 128, 129, 0.1); }
        button { padding: 0.75rem 1.5rem; background: var(--color-primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; }
        button:hover { background: var(--color-primary-hover); }
        button.secondary { background: var(--color-text-secondary); }
        button.danger { background: var(--color-error); }
        .trades-table { width: 100%; border-collapse: collapse; background: var(--color-surface); border-radius: 8px; font-size: 0.9rem; }
        .trades-table thead { background: var(--color-primary); color: white; }
        .trades-table th, .trades-table td { padding: 0.75rem; text-align: left; border-bottom: 1px solid var(--color-border); }
        .status-badge { display: inline-block; padding: 0.4rem 0.8rem; border-radius: 4px; font-size: 0.85rem; font-weight: 600; }
        .status-badge.open { background: rgba(59, 130, 246, 0.2); color: #1e40af; }
        .status-badge.closed { background: rgba(34, 197, 94, 0.2); color: #15803d; }
        .status-badge.assigned { background: rgba(245, 158, 11, 0.2); color: #92400e; }
        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
        .summary-card { background: var(--color-surface); padding: 1.5rem; border-radius: 8px; border-left: 4px solid var(--color-primary); }
        .summary-card h3 { margin: 0 0 0.5rem 0; color: var(--color-text-secondary); font-size: 0.9rem; text-transform: uppercase; }
        .summary-card .value { font-size: 1.8rem; font-weight: 700; color: var(--color-primary); margin: 0; }
        .summary-card.positive .value { color: var(--color-success); }
        .summary-card.negative .value { color: var(--color-error); }
        .alert { padding: 1rem; border-radius: 6px; margin-bottom: 1rem; display: none; }
        .alert.show { display: block; }
        .alert.success { background: rgba(34, 197, 94, 0.2); color: #15803d; border-left: 4px solid var(--color-success); }
        .alert.error { background: rgba(239, 68, 68, 0.2); color: #7f1d1d; border-left: 4px solid var(--color-error); }
        #mainApp { display: none; }
        #mainApp.show { display: block; }
    </style>
</head>
<body>
    <div class="auth-container" id="authContainer">
        <div class="auth-box">
            <h2>üîí Options Wheel Tracker</h2>
            <p>Sign in with Google to save trades to your Google Drive (encrypted)</p>
            <div class="google-signin-wrapper">
                <div id="g_id_onload" data-client_id="YOUR_GOOGLE_CLIENT_ID.apps.googleusercontent.com" data-callback="handleCredentialResponse" data-auto_prompt="false"></div>
                <div class="g_id_signin" data-type="standard" data-size="large" data-theme="outline" data-text="signin_with"></div>
            </div>
            <div id="authStatus" style="display:none; text-align: center; margin-top: 1.5rem;">
                <div class="loading-spinner"></div>
                <p style="margin-top: 1rem; color: var(--color-text-secondary);">Connecting to Google Drive...</p>
            </div>
        </div>
    </div>

    <div id="mainApp">
        <div class="container">
            <header>
                <h1>üìä Options Wheel Tracker Pro</h1>
                <p style="margin: 0.5rem 0 0 0; color: var(--color-text-secondary);">Track & analyze wheel trades. Data saved encrypted to your Google Drive</p>
                <div class="user-header">
                    <img id="userAvatar" class="user-avatar" src="" alt="User">
                    <div class="user-info">
                        <p class="user-name" id="userName"></p>
                        <p class="user-email" id="userEmail"></p>
                    </div>
                    <button class="logout-btn" onclick="handleLogout()">Logout</button>
                </div>
                <div class="encryption-status">üîê Encrypted & saved to Google Drive. Last synced: <span id="lastSync">Never</span></div>
            </header>

            <div class="alert" id="alert"></div>

            <div class="tabs">
                <button class="tab-btn active" data-tab="dashboard">Dashboard</button>
                <button class="tab-btn" data-tab="trades">Trades</button>
                <button class="tab-btn" data-tab="add-trade">Add Trade</button>
                <button class="tab-btn" data-tab="backtest">Backtest</button>
                <button class="tab-btn" data-tab="tax">Tax Report</button>
            </div>

            <div id="dashboard" class="tab-content active">
                <div class="summary-grid">
                    <div class="summary-card"><h3>Total Premium</h3><p class="value" id="totalPremium">$0.00</p></div>
                    <div class="summary-card"><h3>Active</h3><p class="value" id="activePositions">0</p></div>
                    <div class="summary-card"><h3>Closed</h3><p class="value" id="closedTrades">0</p></div>
                    <div class="summary-card positive"><h3>Profit/Loss</h3><p class="value" id="totalProfitLoss">$0.00</p></div>
                    <div class="summary-card"><h3>Win Rate</h3><p class="value" id="winRate">0%</p></div>
                    <div class="summary-card"><h3>ROI</h3><p class="value" id="totalROI">0%</p></div>
                </div>
                <div class="form-section"><h2>Recent Trades</h2><div id="recentTrades" style="overflow-x: auto;"></div></div>
            </div>

            <div id="trades" class="tab-content">
                <div class="form-section"><h2>All Trades</h2><div id="tradesList" style="overflow-x: auto;"></div></div>
            </div>

            <div id="add-trade" class="tab-content">
                <div class="form-section">
                    <h2>Add New Trade</h2>
                    <div class="form-group" style="margin-bottom: 1.5rem;"><label>Trade Type</label><select id="tradeType"><option value="covered-call">Covered Call</option><option value="csp">Cash-Secured Put</option><option value="wheel-open">Wheel - Open CSP</option><option value="wheel-assigned">Wheel - Assigned Call</option></select></div>
                    <form id="tradeForm" onsubmit="addTrade(event)">
                        <div class="form-row">
                            <div class="form-group"><label>Symbol *</label><input type="text" id="symbol" required placeholder="TSLA" style="text-transform: uppercase;"></div>
                            <div class="form-group"><label>Trade Date *</label><input type="date" id="tradeDate" required></div>
                        </div>
                        <div class="form-row">
                            <div class="form-group"><label>Strike Price *</label><input type="number" id="strikePrice" required placeholder="100.00" step="0.01" min="0"></div>
                            <div class="form-group"><label>Expiration *</label><input type="date" id="expiration" required></div>
                        </div>
                        <div class="form-row">
                            <div class="form-group"><label>Premium Per Contract *</label><input type="number" id="premium" required placeholder="0.00" step="0.01" min="0"></div>
                            <div class="form-group"><label>Quantity (Contracts) *</label><input type="number" id="quantity" required placeholder="1" step="1" min="1" value="1"></div>
                        </div>
                        <div class="form-row">
                            <div class="form-group"><label>Stock Purchase Price</label><input type="number" id="stockPrice" placeholder="0.00" step="0.01" min="0"></div>
                            <div class="form-group"><label>Shares Held</label><input type="number" id="shares" placeholder="100" step="1" min="0"></div>
                        </div>
                        <div class="form-row">
                            <div class="form-group"><label>Closing Price</label><input type="number" id="closingPrice" placeholder="0.00" step="0.01" min="0"></div>
                            <div class="form-group"><label>Fees ($)</label><input type="number" id="fees" placeholder="0.00" step="0.01" min="0" value="0"></div>
                        </div>
                        <div class="form-row">
                            <div class="form-group"><label>Status *</label><select id="status" required><option value="open">Open</option><option value="closed">Closed</option><option value="assigned">Assigned</option><option value="expired">Expired</option></select></div>
                        </div>
                        <button type="submit" style="width: 100%;">Add Trade</button>
                    </form>
                </div>
            </div>

            <div id="backtest" class="tab-content">
                <div class="form-section">
                    <h2>Backtest</h2>
                    <form id="backtestForm" onsubmit="runBacktest(event)">
                        <div class="form-row">
                            <div class="form-group"><label>Symbol *</label><input type="text" id="backtestSymbol" required placeholder="AAPL" style="text-transform: uppercase;"></div>
                            <div class="form-group"><label>Current Price *</label><input type="number" id="backtestPrice" required placeholder="150.00" step="0.01" min="0"></div>
                        </div>
                        <div class="form-row">
                            <div class="form-group"><label>Strike Price *</label><input type="number" id="backtestStrike" required placeholder="155.00" step="0.01" min="0"></div>
                            <div class="form-group"><label>Premium *</label><input type="number" id="backtestPremium" required placeholder="2.50" step="0.01" min="0"></div>
                        </div>
                        <div class="form-row">
                            <div class="form-group"><label>Contracts *</label><input type="number" id="backtestContracts" required placeholder="1" step="1" min="1" value="1"></div>
                            <div class="form-group"><label>Fees</label><input type="number" id="backtestFee" placeholder="10.00" step="0.01" min="0" value="10"></div>
                        </div>
                        <button type="submit" style="width: 100%;">Run Backtest</button>
                    </form>
                    <div id="backtestResults"></div>
                </div>
            </div>

            <div id="tax" class="tab-content">
                <div class="form-section"><h2>Tax Report</h2><div id="taxSummary"></div></div>
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let trades = [];
        let accessToken = null;
        let driveFileId = null;
        const FOLDER_NAME = 'OptionsWheelTracker';
        const FILE_NAME = 'trades.json';

        function initGoogle() {
            gapi.load('client', async () => {
                try {
                    await gapi.client.init({
                        discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest']
                    });
                } catch (e) { console.log('API init error:', e); }
            });
        }

        function handleCredentialResponse(response) {
            try {
                document.getElementById('authStatus').style.display = 'block';
                
                const base64Url = response.credential.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map((c) => {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
                
                currentUser = JSON.parse(jsonPayload);
                accessToken = response.credential;

                setTimeout(loadFromDrive, 800);
            } catch (e) {
                console.error('Auth error:', e);
                showAlert('Auth failed', 'error');
            }
        }

        window.onload = function () {
            initGoogle();
            google.accounts.id.initialize({
                client_id: 'YOUR_GOOGLE_CLIENT_ID.apps.googleusercontent.com',
                callback: handleCredentialResponse
            });
            google.accounts.id.renderButton(
                document.querySelector('.google-signin-wrapper'),
                { theme: 'outline', size: 'large' }
            );
        };

        async function loadFromDrive() {
            if (!currentUser) return;
            try {
                let folderId = await getFolderId();
                if (!folderId) {
                    folderId = await createFolder();
                }

                let fileId = await getFileId(folderId);
                if (fileId) {
                    driveFileId = fileId;
                    const content = await getFileContent(fileId);
                    if (content) {
                        const key = generateKey(currentUser.email);
                        const decrypted = decryptData(content, key);
                        if (decrypted && Array.isArray(decrypted)) {
                            trades = decrypted;
                        }
                    }
                }

                document.getElementById('authStatus').style.display = 'none';
                showApp();
                updateDashboard();
            } catch (e) {
                console.error('Load error:', e);
                document.getElementById('authStatus').style.display = 'none';
                showApp();
            }
        }

        async function getFolderId() {
            try {
                const res = await fetch(`https://www.googleapis.com/drive/v3/files?q=name='${FOLDER_NAME}' and mimeType='application/vnd.google-apps.folder' and trashed=false&spaces=drive&fields=files(id)`, {
                    headers: { 'Authorization': 'Bearer ' + accessToken }
                });
                const data = await res.json();
                return data.files && data.files[0] ? data.files[0].id : null;
            } catch (e) { return null; }
        }

        async function createFolder() {
            try {
                const res = await fetch('https://www.googleapis.com/drive/v3/files', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + accessToken,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: FOLDER_NAME,
                        mimeType: 'application/vnd.google-apps.folder'
                    })
                });
                const data = await res.json();
                return data.id;
            } catch (e) { return null; }
        }

        async function getFileId(folderId) {
            try {
                const res = await fetch(`https://www.googleapis.com/drive/v3/files?q=name='${FILE_NAME}' and '${folderId}' in parents and trashed=false&spaces=drive&fields=files(id)`, {
                    headers: { 'Authorization': 'Bearer ' + accessToken }
                });
                const data = await res.json();
                return data.files && data.files[0] ? data.files[0].id : null;
            } catch (e) { return null; }
        }

        async function getFileContent(fileId) {
            try {
                const res = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`, {
                    headers: { 'Authorization': 'Bearer ' + accessToken }
                });
                return await res.text();
            } catch (e) { return null; }
        }

        async function saveToDrive() {
            if (!currentUser || !accessToken) return;
            try {
                const key = generateKey(currentUser.email);
                const encrypted = encryptData(trades, key);

                let folderId = await getFolderId();
                if (!folderId) folderId = await createFolder();

                if (!driveFileId) {
                    const formData = new FormData();
                    formData.append('metadata', new Blob([JSON.stringify({ name: FILE_NAME, parents: [folderId] })], { type: 'application/json' }));
                    formData.append('file', new Blob([encrypted], { type: 'application/json' }));

                    const res = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                        method: 'POST',
                        headers: { 'Authorization': 'Bearer ' + accessToken },
                        body: formData
                    });
                    const data = await res.json();
                    driveFileId = data.id;
                } else {
                    const blob = new Blob([encrypted], { type: 'application/json' });
                    await fetch(`https://www.googleapis.com/upload/drive/v3/files/${driveFileId}?uploadType=media`, {
                        method: 'PATCH',
                        headers: { 'Authorization': 'Bearer ' + accessToken },
                        body: blob
                    });
                }

                document.getElementById('lastSync').textContent = new Date().toLocaleTimeString();
                showAlert('‚úì Saved to Google Drive', 'success');
            } catch (e) {
                console.error('Save error:', e);
                showAlert('Error saving', 'error');
            }
        }

        function generateKey(email) {
            return CryptoJS.SHA256(email).toString();
        }

        function encryptData(data, key) {
            return CryptoJS.AES.encrypt(JSON.stringify(data), key).toString();
        }

        function decryptData(str, key) {
            try {
                const decrypted = CryptoJS.AES.decrypt(str, key);
                return JSON.parse(decrypted.toString(CryptoJS.enc.Utf8));
            } catch (e) { return null; }
        }

        function showApp() {
            document.getElementById('authContainer').classList.add('hidden');
            document.getElementById('mainApp').classList.add('show');
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userEmail').textContent = currentUser.email;
            document.getElementById('userAvatar').src = currentUser.picture;
            document.getElementById('tradeDate').valueAsDate = new Date();
            document.getElementById('expiration').valueAsDate = new Date();
            setupTabs();
        }

        function handleLogout() {
            if (confirm('Logout?')) {
                currentUser = null;
                trades = [];
                location.reload();
            }
        }

        function setupTabs() {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    e.target.classList.add('active');
                    document.getElementById(e.target.dataset.tab).classList.add('active');
                    if (e.target.dataset.tab === 'tax') generateTaxReport();
                    updateDashboard();
                });
            });
        }

        function addTrade(e) {
            e.preventDefault();
            const trade = {
                id: Date.now(),
                symbol: document.getElementById('symbol').value.toUpperCase(),
                tradeType: document.getElementById('tradeType').value,
                tradeDate: document.getElementById('tradeDate').value,
                strikePrice: parseFloat(document.getElementById('strikePrice').value),
                expiration: document.getElementById('expiration').value,
                premium: parseFloat(document.getElementById('premium').value),
                quantity: parseInt(document.getElementById('quantity').value),
                stockPrice: parseFloat(document.getElementById('stockPrice').value) || 0,
                shares: parseInt(document.getElementById('shares').value) || 0,
                closingPrice: parseFloat(document.getElementById('closingPrice').value) || 0,
                fees: parseFloat(document.getElementById('fees').value) || 0,
                status: document.getElementById('status').value
            };
            trades.push(trade);
            saveToDrive();
            showAlert('Trade added! ‚úì', 'success');
            document.getElementById('tradeForm').reset();
            document.getElementById('tradeDate').valueAsDate = new Date();
            document.getElementById('expiration').valueAsDate = new Date();
            updateDashboard();
        }

        function deleteTrade(id) {
            if (confirm('Delete?')) {
                trades = trades.filter(t => t.id !== id);
                saveToDrive();
                updateDashboard();
            }
        }

        function updateDashboard() {
            const totalPrem = trades.reduce((s, t) => s + (t.premium * t.quantity * 100), 0);
            const active = trades.filter(t => t.status === 'open').length;
            const closed = trades.filter(t => t.status === 'closed').length;
            let pl = 0, wins = 0;

            trades.forEach(t => {
                if (t.closingPrice > 0) {
                    let profit = t.premium * t.quantity * 100;
                    if (t.stockPrice > 0) {
                        profit += (t.closingPrice - t.stockPrice) * t.shares;
                    }
                    profit -= t.fees;
                    pl += profit;
                    if (profit > 0) wins++;
                }
            });

            document.getElementById('totalPremium').textContent = '$' + totalPrem.toFixed(2);
            document.getElementById('activePositions').textContent = active;
            document.getElementById('closedTrades').textContent = closed;
            document.getElementById('winRate').textContent = (trades.length > 0 ? (wins / trades.length * 100).toFixed(1) : 0) + '%';
            document.getElementById('totalProfitLoss').textContent = '$' + pl.toFixed(2);
            document.getElementById('totalROI').textContent = (totalPrem > 0 ? (pl / totalPrem * 100).toFixed(1) : 0) + '%';

            const card = document.getElementById('totalProfitLoss').parentElement;
            card.className = 'summary-card ' + (pl >= 0 ? 'positive' : 'negative');

            renderTrades();
        }

        function renderTrades() {
            const sorted = [...trades].reverse();
            let recentHtml = '', allHtml = '';

            if (sorted.length === 0) {
                recentHtml = '<p>No trades yet</p>';
                allHtml = '<p>No trades yet</p>';
            } else {
                const header = `<table class="trades-table"><thead><tr><th>Symbol</th><th>Type</th><th>Strike</th><th>Exp</th><th>Premium</th><th>Fees</th><th>Status</th><th>Action</th></tr></thead><tbody>`;
                sorted.forEach((t, i) => {
                    const row = `<tr><td><b>${t.symbol}</b></td><td>${t.tradeType}</td><td>$${t.strikePrice.toFixed(2)}</td><td>${t.expiration}</td><td>$${(t.premium * t.quantity * 100).toFixed(2)}</td><td>$${t.fees.toFixed(2)}</td><td><span class="status-badge ${t.status}">${t.status}</span></td><td><button class="action-btn delete" onclick="deleteTrade(${t.id})">Delete</button></td></tr>`;
                    allHtml += row;
                    if (i < 5) recentHtml += row;
                });
                recentHtml = header + recentHtml + '</tbody></table>';
                allHtml = header + allHtml + '</tbody></table>';
            }

            document.getElementById('recentTrades').innerHTML = recentHtml;
            document.getElementById('tradesList').innerHTML = allHtml;
        }

        function runBacktest(e) {
            e.preventDefault();
            const s = document.getElementById('backtestSymbol').value;
            const cp = parseFloat(document.getElementById('backtestPrice').value);
            const sp = parseFloat(document.getElementById('backtestStrike').value);
            const p = parseFloat(document.getElementById('backtestPremium').value);
            const c = parseInt(document.getElementById('backtestContracts').value);
            const f = parseFloat(document.getElementById('backtestFee').value);

            const tp = p * c * 100;
            const cr = sp * c * 100;
            const ep = tp - f;
            const ap = ((sp - cp) * c * 100) + tp - f;

            const html = `<div style="margin-top:1.5rem;"><h3>${s} Backtest</h3><div class="summary-grid"><div class="summary-card"><h3>Capital</h3><p class="value">$${cr.toFixed(2)}</p></div><div class="summary-card"><h3>Premium</h3><p class="value">$${tp.toFixed(2)}</p></div><div class="summary-card"><h3>ROI</h3><p class="value">${(ep/cr*100).toFixed(2)}%</p></div><div class="summary-card positive"><h3>Expires OTM</h3><p class="value">+$${ep.toFixed(2)}</p></div><div class="summary-card"><h3>If Assigned</h3><p class="value" style="color: ${ap >= 0 ? 'var(--color-success)' : 'var(--color-error)'};">${ap >= 0 ? '+' : ''}$${ap.toFixed(2)}</p></div></div></div>`;
            document.getElementById('backtestResults').innerHTML = html;
        }

        function generateTaxReport() {
            let st = 0, lt = 0, sf = 0, sc = 0;
            trades.forEach(t => {
                if (t.status === 'closed') {
                    const dd = (new Date(t.expiration) - new Date(t.tradeDate)) / (1000 * 60 * 60 * 24);
                    let p = t.premium * t.quantity * 100;
                    if (t.stockPrice > 0) p += (t.closingPrice - t.stockPrice) * t.shares;
                    p -= t.fees;
                    if (dd <= 365) st += p;
                    else lt += p;
                    sf += (t.status === 'closed' ? t.fees : 0);
                    sc++;
                }
            });

            const html = `<div class="summary-grid"><div class="summary-card"><h3>Short-Term Gains</h3><p class="value" style="color:${st>=0?'var(--color-success)':'var(--color-error)'}">${st>=0?'+':''}$${st.toFixed(2)}</p></div><div class="summary-card"><h3>Long-Term Gains</h3><p class="value" style="color:${lt>=0?'var(--color-success)':'var(--color-error)'}">${lt>=0?'+':''}$${lt.toFixed(2)}</p></div><div class="summary-card"><h3>Total Fees</h3><p class="value">-$${sf.toFixed(2)}</p></div><div class="summary-card"><h3>Closed Trades</h3><p class="value">${sc}</p></div></div>`;
            document.getElementById('taxSummary').innerHTML = html;
        }

        function showAlert(msg, type) {
            const a = document.getElementById('alert');
            a.textContent = msg;
            a.className = `alert ${type} show`;
            setTimeout(() => a.classList.remove('show'), 3000);
        }
    </script>
</body>
</html>
